---
import '../assets/normalize.css'
import '../assets/style.css'
import '../assets/global.css'
import { SEO } from 'astro-seo'
import { getEnv } from '../lib/env'
import backToTopIcon from '../assets/back-to-top.svg'

const { SITE_URL, RSS_URL, RSS_PREFIX } = Astro.locals
const { channel } = Astro.props

const locale = getEnv(import.meta.env, Astro, 'LOCALE')

const seo = channel?.seo
const reqPathname = Astro.url.pathname.replace(/\/$/, '')
const canonical = SITE_URL.startsWith('http') ? new URL(SITE_URL).origin + reqPathname : Astro.url.origin + reqPathname

const { origin, pathname } = new URL(canonical)
const twitter = getEnv(import.meta.env, Astro, 'TWITTER')

const seoParams = {
  title: seo?.title,
  description: seo?.text ?? channel?.description,
  canonical,
  noindex: seo?.noindex ?? getEnv(import.meta.env, Astro, 'NOINDEX'),
  nofollow: seo?.nofollow ?? getEnv(import.meta.env, Astro, 'NOFOLLOW'),
  openGraph: {
    basic: {
      type: 'website',
      title: channel?.title ?? '',
      url: canonical,
      image: channel?.avatar ? channel.avatar : origin + '/favicon.ico',
    },
    optional: {
      description: seo?.text ?? channel?.description,
      locale,
    },
  },
  extend: {
    link: [
      {
        rel: 'icon',
        href: channel?.avatar
          ? `https://wsrv.nl/?w=64&h=64&fit=cover&mask=circle&url=ssl:${channel?.avatar?.replace(/^https?:\/\//, '')}`
          : '/favicon.svg',
      },
    ],
  },
}

const GOOGLE_SEARCH_SITE = getEnv(import.meta.env, Astro, 'GOOGLE_SEARCH_SITE')
const searchAction = GOOGLE_SEARCH_SITE ? 'https://www.google.com/search' : '/search/result'

const HEADER_INJECT = getEnv(import.meta.env, Astro, 'HEADER_INJECT')
const FOOTER_INJECT = getEnv(import.meta.env, Astro, 'FOOTER_INJECT')
const TAGS = getEnv(import.meta.env, Astro, 'TAGS')
const LINKS = getEnv(import.meta.env, Astro, 'LINKS')
const navs = (getEnv(import.meta.env, Astro, 'NAVS') || '')
  .split(';')
  .filter(Boolean)
  .map((link) => {
    link = link.split(',')
    return {
      title: link[0],
      href: link[1],
    }
  })
---

<!doctype html>
<html lang={locale ?? 'en'}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f0f4f8" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0c0c0f" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="alternate" type="application/rss+xml" title={`${RSS_PREFIX}${channel?.title}`} href={RSS_URL} />
    <style is:inline>
      @view-transition {
        navigation: auto; /* enabled */
      }
    </style>
    <script is:inline>
      // ç«‹å³è®¾ç½®åˆå§‹ä¸»é¢˜ï¼Œé¿å…é—ªçƒ
      (function() {
        // å¼ºåˆ¶ç¦ç”¨æ‰€æœ‰è¿‡æ¸¡åŠ¨ç”»ï¼Œæ—¶é—´æ›´é•¿
        const disableTransitions = () => {
          const style = document.createElement('style');
          style.innerHTML = `
            *, *::before, *::after { 
              transition: none !important; 
              animation: none !important; 
              animation-duration: 0s !important;
              transition-duration: 0s !important;
            }
          `;
          style.id = 'disable-transitions';
          document.head.appendChild(style);
        };
        
        // ç«‹å³ç¦ç”¨è¿‡æ¸¡
        disableTransitions();
        
        const hour = new Date().getHours();
        const isNight = hour < 6 || hour >= 18;
        const initialTheme = isNight ? 'night' : 'day';
        
        // ç«‹å³è®¾ç½®ä¸»é¢˜å±æ€§
        document.documentElement.setAttribute('data-theme', initialTheme);
        if (document.body) {
          document.body.setAttribute('data-theme', initialTheme);
        }
        
        // ç«‹å³æ›´æ–°æµè§ˆå™¨ä¸»é¢˜è‰²
        let themeColorMeta = document.querySelector('meta[name="theme-color"]');
        if (themeColorMeta) {
          themeColorMeta.content = isNight ? '#0c0c0f' : '#f0f4f8';
        }
        
        // å»¶è¿Ÿæ›´é•¿æ—¶é—´å†å¯ç”¨è¿‡æ¸¡
        setTimeout(() => {
          const disableStyle = document.getElementById('disable-transitions');
          if (disableStyle) {
            disableStyle.remove();
          }
        }, 300);
        
        // ç¡®ä¿DOMåŠ è½½åç«‹å³æ›´æ–°ä¸»é¢˜æ–‡æœ¬
        const updateInitialThemeText = () => {
          const themeText = document.getElementById('theme-text');
          if (themeText) {
            themeText.textContent = initialTheme === 'night' ? 'å¤œæ™š' : 'ç™½å¤©';
            console.log('åˆå§‹ä¸»é¢˜æ–‡æœ¬å·²æ›´æ–°ä¸º:', themeText.textContent);
          } else {
            // å¦‚æœå…ƒç´ è¿˜æ²¡åŠ è½½ï¼Œç¨åé‡è¯•
            setTimeout(updateInitialThemeText, 10);
          }
        };
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', updateInitialThemeText);
        } else {
          updateInitialThemeText();
        }
      })();
    </script>
    <SEO
      titleTemplate={`%s | ${channel?.title}`}
      titleDefault={[channel?.title, seoParams.description].filter(Boolean).join(' - ')}
      twitter={{
        card: 'summary_large_image',
        creator: twitter ? `@${twitter}` : undefined,
      }}
      {...seoParams}
    />
    <Fragment set:html={HEADER_INJECT} />
  </head>

  <body>
    <div id="wrapper">
      <div id="container">
        <div id="main-container">
          <slot />
        </div>
        <div id="aside-container">
          <slot name="aside">
            <div class="nav">
              <div class="nav-item">
                <a href={SITE_URL} title={channel?.title} class={`nav-link ${pathname === '/' ? 'current' : ''}`}>
                  Home
                </a>
              </div>
              {
                TAGS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}tags`}
                      title="çœä»½ç›´è¾¾"
                      class={`nav-link ${pathname === '/tags' ? 'current' : ''}`}
                    >
                      çœä»½ç›´è¾¾
                    </a>
                  </div>
                ) : null
              }
              {
                LINKS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}links`}
                      title="å¤–éƒ¨é“¾æ¥"
                      class={`nav-link ${pathname === '/links' ? 'current' : ''}`}
                    >
                      å¤–éƒ¨é“¾æ¥
                    </a>
                  </div>
                ) : null
              }
              {
                navs.map((nav) => (
                  <div class="nav-item">
                    <a href={nav.href} title={nav.title} target="_blank" rel="noopener" class="nav-link">
                      {nav.title}
                    </a>
                  </div>
                ))
              }
              <div class="nav-item">
                <button id="theme-toggle" class="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">
                  <span class="theme-icon day-icon">â˜€ï¸</span>
                  <span class="theme-icon night-icon">ğŸŒ™</span>
                  <span class="toggle-text" id="theme-text">ä¸»é¢˜</span>
                </button>
              </div>
            </div>
            <input class="search-icon" name="icon" type="checkbox" placeholder="ğŸ”" />
            <form class="search-form" action={searchAction} method="get">
              {GOOGLE_SEARCH_SITE ? <input type="hidden" name="as_sitesearch" value={GOOGLE_SEARCH_SITE} /> : null}
              <input type="text" name="q" placeholder="ğŸ”" />
            </form>
            {channel?.stats && (channel.stats.subscribers > 0 || channel.stats.photos > 0 || channel.stats.links > 0) && (
              <div class="channel-stats">
                {channel.stats.subscribers > 0 && (
                  <div class="stat-item">
                    <span class="stat-emoji bright-emoji stats-emoji">ğŸ”¥</span>
                    <span class="stat-text">{channel.stats.subscribers} è®¢é˜…è€…</span>
                  </div>
                )}
                {channel.stats.photos > 0 && (
                  <div class="stat-item">
                    <span class="stat-emoji bright-emoji stats-emoji">ğŸŒˆ</span>
                    <span class="stat-text">{channel.stats.photos} å›¾ç‰‡</span>
                  </div>
                )}
                {channel.stats.links > 0 && (
                  <div class="stat-item">
                    <span class="stat-emoji bright-emoji stats-emoji">âš¡</span>
                    <span class="stat-text">{channel.stats.links} é“¾æ¥</span>
                  </div>
                )}
              </div>
            )}
            <div class="copyright-wrap">
              Powered by
              <a
                href="https://ll.sd"
                title="drfy"
                target="_blank"
                rel="noopener"
              >
                Drfy
              </a> &
              <a href="https://i8qiu.com" title="ç§‹å¤©å¡åœˆ" target="_blank" rel="noopener">
                ç§‹å¤©å¡åœˆ
              </a>
            </div>
          </slot>
        </div>
      </div>
    </div>
    <a href="#wrapper" id="back-to-top" aria-label="Back to top">
      <img {...backToTopIcon} alt="Back to Top" />
    </a>
    <script is:inline>
      // å®Œæ•´çš„ä¸»é¢˜åˆ‡æ¢å™¨
      class ThemeSwitcher {
        constructor() {
          this.init();
        }

        init() {
          this.applyTimeBasedTheme();
          
          setInterval(() => {
            this.applyTimeBasedTheme();
          }, 60000);
          
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
              this.applyTimeBasedTheme();
            }
          });
        }

        isNightTime() {
          const hour = new Date().getHours();
          return hour < 6 || hour >= 18;
        }

        updateThemeText(theme) {
          const themeText = document.getElementById('theme-text');
          if (themeText) {
            const newText = theme === 'night' ? 'å¤œæ™š' : 'ç™½å¤©';
            themeText.textContent = newText;
            console.log('ä¸»é¢˜æ–‡æœ¬å·²æ›´æ–°ä¸º:', newText, '(ä¸»é¢˜:', theme, ')');
          } else {
            console.warn('æœªæ‰¾åˆ°ä¸»é¢˜æ–‡æœ¬å…ƒç´ ');
          }
        }

        applyTimeBasedTheme() {
          const isNight = this.isNightTime();
          const currentTheme = document.body.getAttribute('data-theme');
          const newTheme = isNight ? 'night' : 'day';
          
          if (currentTheme !== newTheme) {
            document.body.setAttribute('data-theme', newTheme);
            document.documentElement.setAttribute('data-theme', newTheme);
            this.updateThemeColor(isNight);
            this.updateThemeText(newTheme);
            
            document.dispatchEvent(new CustomEvent('themechange', {
              detail: { theme: newTheme, isNight, manual: false }
            }));
          }
        }

        updateThemeColor(isNight) {
          let themeColorMeta = document.querySelector('meta[name="theme-color"]');
          if (themeColorMeta) {
            const themeColor = isNight ? '#0c0c0f' : '#f0f4f8';
            themeColorMeta.content = themeColor;
            
            // æ›´æ–°è‹¹æœè®¾å¤‡çŠ¶æ€æ æ ·å¼
            let appleStatusMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
            if (appleStatusMeta) {
              appleStatusMeta.content = isNight ? 'black-translucent' : 'default';
            }
          }
        }

        setTheme(theme) {
          if (['day', 'night'].includes(theme)) {
            // æ·»åŠ æ·¡å…¥æ·¡å‡ºæ•ˆæœ
            document.body.style.opacity = '0.7';
            document.body.style.transition = 'opacity 0.3s ease-out';
            
            setTimeout(() => {
              document.body.setAttribute('data-theme', theme);
              document.documentElement.setAttribute('data-theme', theme);
              this.updateThemeColor(theme === 'night');
              this.updateThemeText(theme);
              
              // ä¿å­˜ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©çš„ä¸»é¢˜åå¥½
              localStorage.setItem('user-theme-preference', theme);
              localStorage.setItem('theme-override-time', Date.now().toString());
              
              // æ·¡å…¥å›æ¥
              setTimeout(() => {
                document.body.style.opacity = '1';
                setTimeout(() => {
                  document.body.style.transition = '';
                }, 300);
              }, 50);
            }, 150);
          }
        }

        getCurrentTheme() {
          return document.body.getAttribute('data-theme') || 'day';
        }

        toggleTheme() {
          const currentTheme = this.getCurrentTheme();
          const newTheme = currentTheme === 'day' ? 'night' : 'day';
          console.log('åˆ‡æ¢ä¸»é¢˜ä»', currentTheme, 'åˆ°', newTheme);
          this.setTheme(newTheme);
          
          // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
          document.dispatchEvent(new CustomEvent('themechange', {
            detail: { theme: newTheme, isNight: newTheme === 'night', manual: true }
          }));
        }

        // æ£€æŸ¥æ˜¯å¦åº”è¯¥åº”ç”¨ç”¨æˆ·åå¥½è€Œä¸æ˜¯æ—¶é—´
        shouldUseUserPreference() {
          const preference = localStorage.getItem('user-theme-preference');
          const overrideTime = localStorage.getItem('theme-override-time');
          
          if (!preference || !overrideTime) return false;
          
          // ç”¨æˆ·åå¥½æœ‰æ•ˆæœŸï¼š2å°æ—¶
          const twoHours = 2 * 60 * 60 * 1000;
          return (Date.now() - parseInt(overrideTime)) < twoHours;
        }

        // ä¿®æ”¹åº”ç”¨ä¸»é¢˜çš„é€»è¾‘ï¼Œè€ƒè™‘ç”¨æˆ·åå¥½
        applyTimeBasedTheme() {
          // å¦‚æœç”¨æˆ·æœ€è¿‘æ‰‹åŠ¨é€‰æ‹©äº†ä¸»é¢˜ï¼Œä½¿ç”¨ç”¨æˆ·åå¥½
          if (this.shouldUseUserPreference()) {
            const userTheme = localStorage.getItem('user-theme-preference');
            const currentTheme = document.body.getAttribute('data-theme');
            
            if (currentTheme !== userTheme) {
              document.body.setAttribute('data-theme', userTheme);
              document.documentElement.setAttribute('data-theme', userTheme);
              this.updateThemeColor(userTheme === 'night');
              this.updateThemeText(userTheme);
            }
            return;
          }
          
          // å¦åˆ™ä½¿ç”¨åŸºäºæ—¶é—´çš„è‡ªåŠ¨åˆ‡æ¢
          const isNight = this.isNightTime();
          const currentTheme = document.body.getAttribute('data-theme');
          const newTheme = isNight ? 'night' : 'day';
          
          if (currentTheme !== newTheme) {
            document.body.setAttribute('data-theme', newTheme);
            document.documentElement.setAttribute('data-theme', newTheme);
            this.updateThemeColor(isNight);
            this.updateThemeText(newTheme);
            
            document.dispatchEvent(new CustomEvent('themechange', {
              detail: { theme: newTheme, isNight, manual: false }
            }));
          }
        }
      }

      // åˆå§‹åŒ–ä¸»é¢˜åˆ‡æ¢å™¨å’ŒæŒ‰é’®äº‹ä»¶
      function initTheme() {
        window.themeSwitcher = new ThemeSwitcher();
        
        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const toggleButton = document.getElementById('theme-toggle');
        if (toggleButton) {
          toggleButton.addEventListener('click', () => {
            // é˜²æ­¢å¿«é€Ÿè¿å‡»
            if (toggleButton.dataset.clicking === 'true') return;
            toggleButton.dataset.clicking = 'true';
            
            // ç«‹å³å¤±ç„¦ï¼Œç§»é™¤focusæ¡†çº¿
            toggleButton.blur();
            
            window.themeSwitcher.toggleTheme();
            
            setTimeout(() => {
              toggleButton.dataset.clicking = 'false';
            }, 300);
          });
        }
        
        // æœ€åç¡®ä¿æ–‡æœ¬æ˜¾ç¤ºæ­£ç¡®
        setTimeout(() => {
          const currentTheme = document.body.getAttribute('data-theme') || 'day';
          window.themeSwitcher.updateThemeText(currentTheme);
          console.log('åˆå§‹åŒ–å®Œæˆï¼Œæœ€ç»ˆä¸»é¢˜:', currentTheme);
        }, 100);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTheme);
      } else {
        initTheme();
      }
    </script>
    <Fragment set:html={FOOTER_INJECT} />
  </body>
</html>
